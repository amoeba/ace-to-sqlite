name: Export ACE to SQLite
on:
  - workflow_dispatch
  - push

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Start MySQL
        run: sudo systemctl start mysql.service
      - name: Download latest World release
        uses: robinraju/release-downloader@v1.7
        with:
          repository: ACEmulator/ACE-World-16PY-Patches
          latest: true
          fileName: ACE.World*.zip
      - name: Decompress latest World release
        run: find . -iname "ACE-World*.zip" -exec unzip {} \;
      - name: Load ACE SQL
        run: sudo sh scripts/load.sh
      - name: Export ACE
        run: sudo sh scripts/export.sh
      - name: Relax permissions
        run: sudo chmod -R o+rwx /var/lib/mysql-files
      - name: Install datasette and csvs-to-sqlite
        run: python3 -m pip install datasette csvs-to-sqlite
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
      - name: Create Auth database
        run: csvs-to-sqlite -s \t ./ace_auth/*.tsv ace_auth.db
      - name: Create Shard database
        run: csvs-to-sqlite -s \t ./ace_shard/*.tsv ace_shard.db
      - name: Create World database
        run: csvs-to-sqlite -s \t ./ace_world/*.tsv ace_world.db
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - run: datasette install datasette-publish-fly
      - run: datasette publish fly ace_auth.db ace_shard.db ace_world.db --app="acemu-db"
        env:
          FLY_APP: $${secrets.FLY_APP}
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
