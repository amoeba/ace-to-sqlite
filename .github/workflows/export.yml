name: Export ACE to SQLite
on:
  - workflow_dispatch

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Start MySQL
        run: sudo systemctl start mysql.service
      - name: Download latest ACE release
        uses: robinraju/release-downloader@v1.7
        with:
          repository: ACEmulator/ace
          latest: true
          fileName: ACE.Server.zip
      - name: Decompress latest release
        run: unzip ACE.Server.zip
      - name: Download latest World release
        uses: robinraju/release-downloader@v1.7
        with:
          repository: ACEmulator/ACE-World-16PY-Patches
          latest: true
          fileName: ACE.World*.zip
      - name: Decompress latest World release
        run: find . -iname "ACE-World*.zip" -exec unzip {} \;
      - name: Load ACE SQL
        run: sudo sh scripts/load.sh
      - name: Export ACE
        run: sudo sh scripts/export.sh
      - name: Relax permissions
        run: sudo chmod -R o+rwx /var/lib/mysql-files
      - uses: actions/upload-artifact@v3
        with:
          name: export
          path: /var/lib/mysql-files/
  publish:
    runs-on: ubuntu-latest
    needs: export
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: export
      - name: Install datasette and csvs-to-sqlite
        run: python -m pip install datasette csvs-to-sqlite
      - name: Create Auth database
        run: csvs-to-sqlite -s \t ./ace_auth/*.tsv ace_auth.db
      - name: Create Shard database
        run: csvs-to-sqlite -s \t ./ace_shard/*.tsv ace_shard.db
      - name: Create World database
        run: csvs-to-sqlite -s \t ./ace_world/*.tsv ace_world.db
      - uses: actions/upload-artifact@v3
        with:
          name: databases
          path: |
            ace_auth.db
            ace_shard.db
            ace_world.db
